--source include/galera_cluster.inc
--source include/have_innodb.inc

#
# Test
#

CREATE TABLE t1 (f1 INTEGER) ENGINE=InnoDB;

set global wsrep_on=OFF;
reset master;
set global wsrep_on=ON;

--connection node_2
set global wsrep_on=OFF;
reset master;
set global wsrep_on=ON;

--connection node_1
ALTER TABLE t1 ADD COLUMN f2 INTEGER, ALGORITHM=INSTANT;
--replace_column 1 LOG_NAME 2 POS 4 SERVER_ID 5 END_LOG_POS
show binlog events limit 1 offset 4;

--connection node_2
--replace_column 1 LOG_NAME 2 POS 4 SERVER_ID 5 END_LOG_POS
show binlog events limit 1 offset 4;


# Phase 2, setting algorithm before alter statement

--connection node_1
set global wsrep_on=OFF;
reset master;
set global wsrep_on=ON;

--connection node_2
set global wsrep_on=OFF;
reset master;
set global wsrep_on=ON;

--connection node_1
SET SESSION alter_algorithm='INSTANT';
ALTER TABLE t1 ADD COLUMN f3 INTEGER;
--replace_column 1 LOG_NAME 2 POS 4 SERVER_ID 5 END_LOG_POS
show binlog events limit 1 offset 4;

--connection node_2
--replace_column 1 LOG_NAME 2 POS 4 SERVER_ID 5 END_LOG_POS
show binlog events limit 1 offset 4;


# Phase 3, setting different algorithm before alter statement

--connection node_1
set global wsrep_on=OFF;
reset master;
set global wsrep_on=ON;

--connection node_2
set global wsrep_on=OFF;
reset master;
set global wsrep_on=ON;

--connection node_1
SET SESSION alter_algorithm='INSTANT';
ALTER TABLE t1 ADD COLUMN f4 INTEGER, ALGORITHM=COPY;
--replace_column 1 LOG_NAME 2 POS 4 SERVER_ID 5 END_LOG_POS
show binlog events limit 1 offset 4;

--connection node_2
--replace_column 1 LOG_NAME 2 POS 4 SERVER_ID 5 END_LOG_POS
show binlog events limit 1 offset 4;


#Cleanup

--connection node_1
DROP TABLE t1;
set global wsrep_on=OFF;
reset master;
set global wsrep_on=ON;

--connection node_2
set global wsrep_on=OFF;
reset master;
set global wsrep_on=ON;
